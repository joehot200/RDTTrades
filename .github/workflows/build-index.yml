name: build-trades-index

on:
  push:
    paths: [ 'trades/*' ]          # run whenever something in /trades changes

permissions:
  contents: write                  # let the workflow push to main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    # 1 ▸ Get the repo; nothing else to configure
    - uses: actions/checkout@v4

    # 2 ▸ Quarantine malformed JSON so jq never crashes
    - name: Validate trade files
      run: |
        shopt -s nullglob
        for f in trades/*.json; do
          if ! jq -e . "$f" >/dev/null 2>&1; then
            echo "::warning ::$f is NOT valid JSON – moving to ${f%.json}.bad"
            mv "$f" "${f%.json}.bad"
          fi
        done

    # 3 ▸ Merge all valid JSON objects into one array
    - name: Build aggregate trades.json
      run: |
        if ls trades/*.json >/dev/null 2>&1; then
          jq -s '.' trades/*.json > trades.json     # -s = “slurp” into array
        else
          echo "[]" > trades.json                   # empty array if none yet
        fi

    # 4 ▸ Commit the result back to main
    - name: Commit updated index
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add trades.json trades/*.bad || true
        git commit -m "build: refresh aggregate trades.json" || echo "Nothing to commit"
        git push
