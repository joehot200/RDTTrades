name: build-trades-index

on:
  push:
    paths: [ 'trades/*' ]

permissions:
  contents: write             # lets the workflow push to main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4      # â†-- NOW you are inside the repo

    - name: Quarantine malformed JSON
      run: |
        shopt -s nullglob
        for f in trades/*.json; do
          jq -e . "$f" >/dev/null 2>&1 || mv "$f" "${f%.json}.bad"
        done

    - name: Build aggregate trades.json
      run: |
        if ls trades/*.json >/dev/null 2>&1; then
          jq -s '.' trades/*.json > trades.json
        else
          echo "[]" > trades.json
        fi

    - name: Commit updated index
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add trades.json trades/*.bad || true
        git commit -m "build: refresh aggregate trades.json" || echo "Nothing to commit"
        git push
