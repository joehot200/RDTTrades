name: build-trades-index

on:
  push:
    paths: [ 'trades/*' ]

permissions:
  contents: write          # allow the workflowâ€™s GITHUB_TOKEN to push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1 â–¸ checkout with manual retry
    - name: Checkout repository (up to 3 tries)
      shell: bash
      run: |
        for i in 1 2 3; do
          echo "ðŸ›Žï¸  git clone attempt $i..."
          if git clone --depth 0 "https://github.com/${{ github.repository }}.git" repo; then
            echo "âœ…  clone succeeded"; break
          elif [ "$i" -eq 3 ]; then
            echo "âŒ  clone failed after 3 attempts"; exit 1
          else
            echo "ðŸ”  retrying in 15 s"; sleep 15
          fi
        done
        cd repo

    # 2 â–¸ quarantine malformed JSON
    - name: Validate trade files
      shell: bash
      run: |
        shopt -s nullglob
        for f in trades/*.json; do
          if ! jq -e . "$f" >/dev/null 2>&1; then
            echo "::warning ::$f is NOT valid JSON â€“ moving to ${f%.json}.bad"
            mv "$f" "${f%.json}.bad"
          fi
        done

    # 3 â–¸ build aggregate
    - name: Merge valid trade files into trades.json
      shell: bash
      run: |
        if ls trades/*.json >/dev/null 2>&1; then
          jq -s '.' trades/*.json > trades.json
        else
          echo "[]" > trades.json
        fi

    # 4 â–¸ commit back to main
    - name: Commit updated index
      shell: bash
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add trades.json trades/*.bad || true
        git commit -m "build: refresh aggregate trades.json" || echo "Nothing to commit"
        git push
